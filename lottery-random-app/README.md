## 抽奖合约

### 功能

- 合约owner 新增、删除管理员
- 管理员角色 新建抽奖
- 管理员角色 新增奖品，设置中奖概率
- 管理员角色 开启、关闭抽奖
- 用户抽奖
- 根据抽奖id查询抽奖信息
- 根据抽奖id和奖品id查询奖品及中奖信息

### 结构

- LotteryData合约：抽奖数据合约，记录新建的抽奖、奖品、概率、中奖信息。所有数据的修改只能通过外部逻辑合约执行。
- LotteryCore合约：可操作抽奖数据合约。可新增admin角色，只有admin角色可执行逻辑合约的抽奖方法。owner角色管理admin角色。

数据逻辑结构分离，基本数据结构固定，外层逻辑更新不影响数据合约。

### 合约部署流程

1. 使用 owner 地址作初始化参数，部署 LotteryData 合约
2. 使用 owner 地址和 LotteryData 地址作参数，部署 LotteryCore 合约
3. 调用 LotteryData.setLotteryCore 方法，参数为LotteryCore地址，设置可执行数据合约的逻辑合约地址
4. 调用 LotteryCore.addAdmin 方法，设置可执行抽奖逻辑的管理员地址

### 关键实现

1. 计算中奖数组

在管理员启动抽奖时，合约方法计算此次抽奖的所有奖品的中奖概率倒数的最小公倍数，然后使用最小公倍数除以每个奖品的中奖概率，得出每个奖品的中奖数组。  
例：  
抽奖 TestLottery 的奖品信息及中奖数组  
| 奖品名称 | 中奖概率 | 概率倒数 | 中奖数组        |
| -------- | -------- | -------- | --------------- |
| 奖品A    | 1%       | 100      | [0]             |
| 奖品B    | 2%       | 50       | [1, 2]          |
| 奖品C    | 5%       | 20       | [3, 4, 5, 6, 7] |

如上：三种奖品的中奖概率倒数的最小公倍数为100，以100除以每个奖品的概率倒数，得到的结果做中奖数组的长度，所有结果的值依次递增。

2. 抽奖逻辑

用户抽奖时，以抽奖时的`blockhash(block.blockNumber - 1)`的uint值做随机数，对上面计算的最小公倍数取模，得到随机值。如果随机值结果在以上奖品的中奖数组里，即表示抽得对应的奖品。  
如：  
```
blockhash(block.blockNumber - 1): 0x140edb3946b533e835bbda977b54eb8409e89360762c06354c06113a65113a36
uint(blockhash): 9072505857185535218599762382005973303930830577825200116624876876697206602294
randomRes: uint(blockhash)%100 = 94 // 未中奖

blockhash(block.blockNumber - 1): 0x3bf8913ae7cc1c309d0ff6d4042e511cb8cf58c1813a3f5f73364af8684fe913
uint(blockhash): 27125638479786052961526441409963553044433113081491242652188832069765506787603
randomRes: uint(blockhash)%100 = 3 // 抽中奖品C
```

### 问题

1. 使用hash的方式产生随机数，概率是否均等还有待验证，后续将构建大量数据验证。
2. hash的产生依赖的是产生随机数的交易时的上一块的hash，所以需要限制外部不能实时同步交易块信息。
